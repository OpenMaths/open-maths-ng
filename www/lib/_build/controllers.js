var gridDefaultRowCount=3,gridDefaultColumnCount=3,gridMaxRows=6,gridMinRows=2,gridMaxColumns=6,gridMinColumns=2,fadeUmiTimeout=250;app.controller("BoardController",["$scope","$http","$timeout","$routeParams",function(e,t,o,r){e.$parent.title="Board",e.$parent.transparentNav=!1,e.rows=sessionStorage.getItem("gridRows")?parseInt(sessionStorage.getItem("gridRows")):gridDefaultRowCount,e.columns=sessionStorage.getItem("gridColumns")?parseInt(sessionStorage.getItem("gridColumns")):gridDefaultColumnCount;var a=r.id;for(e.grid=[],i=0;i<e.rows;i++){var n=[];for(c=0;c<e.columns;c++)n.push(c);e.grid.push(n)}e.manageGrid=function(t,o){if("row"==o){var r=[];for(i=0;i<e.columns;i++)r.push(i);switch(t){case"add":if(e.rows>gridMaxRows-1)return!1;e.rows=e.rows+1,e.grid.push(r);break;case"remove":if(e.rows<gridMinRows+1)return!1;e.rows=e.rows-1,e.grid.pop()}sessionStorage.setItem("gridRows",e.rows)}else if("column"==o){switch(t){case"add":if(e.columns>gridMaxColumns-1)return!1;for(i=0;i<e.rows;i++)e.grid[i].push(e.columns);e.columns=e.columns+1;break;case"remove":if(e.columns<gridMinColumns+1)return!1;for(i=0;i<e.rows;i++)e.grid[i].pop();e.columns=e.columns-1}sessionStorage.setItem("gridColumns",e.columns)}};var s=function(r,i,a,n){var s=function(){e.fadeInUmi=!0},l="uriFriendlyTitle"==r?appConfig.apiUrl+"/"+i:appConfig.apiUrl+"/"+r+"/"+i;t.get(l).success(function(t){n&&(t.targetClasses=n),e.grid[a[0]][a[1]]=t,o(s,fadeUmiTimeout)}).error(function(){e.notify("There was an error loading requested contribution.","error",e.$parent)})};s("uriFriendlyTitle",a,[1,1]),e.position=function(t,o,r,i){var a=[];if("up"==r)var n=[t-1,o];else if("down"==r)var n=[t+1,o];else if("left"==r)var n=[t,o-1];else if("right"==r)var n=[t,o+1];0==n[0]?a.push("closes-top"):n[0]==e.rows-1?a.push("closes-bottom"):0==n[1]?a.push("closes-left"):n[1]==e.columns-1&&a.push("closes-right"),s("id",i,[n[0],n[1]],a.join(" "))}}]);var parseLatexContent,parseLatexContentTimeout=2e3,parseLatexContentProgressTimeout=800;app.controller("ContributeController",["$scope","$http","$location","$timeout","$routeParams",function(e,t,o,r,i){if(e.omUser||(alert("You must be logged in to Contribute to OpenMaths!"),o.path("/")),e.$parent.title="Contribute",e.$parent.transparentNav=!1,e.autocompleteData={},i.edit){var a=i.edit.split(":");"edit"!==a[0]&&o.path("/contribute"),t.get(appConfig.apiUrl+"/"+a[1]).success(function(t){e.editUmiData=t,e.$parent.title=e.editUmiData.title.title,e.createUmiForm={type:{id:t.umiType,label:t.umiType},title:t.title.title,titleSynonyms:t.titleSynonyms,latexContent:t.latexContent,seeAlso:t.seeAlso,tags:t.tags},e.parsedLatexContent=t.htmlContent}).error(function(){e.notify("There was an error loading requested contribution.","error",e.$parent)})}e.steps={"basic-settings":"Basic Settings",editor:"Editor","preview-and-publish":"Preview & Publish"},e.stepsKeys=_.keys(e.steps),e.activeStep=0,e.errorMessages={required:"This field is required.",maxLength:"This field is exceeding the maximum length of 128 characters.",umiTitle:"The title should only consist of letters, spaces, or hyphens"},e.instructions={type:"What category of information?",title:"Users will be able to search your contribution.",titleSynonyms:"Comma-separated list of alternative names.",latexContent:"The actual content. You are free to use LaTeX (including text-mode macros!!).",prerequisiteDefinitions:"Comma-separated list of valid dependency Titles.",seeAlso:"Comma-separated list of valid Titles which may be related.",tags:"Comma-separated list of tags to help users find your contribution.",dispatch:"Submitting your contribution will create a request to pull the content into our database."},e.umiTypes=[{id:"Definition",label:"Definition",formal:"allow"},{id:"Axiom",label:"Axiom",formal:"allow"},{id:"Theorem",label:"Theorem",formal:"allow"},{id:"Lemma",label:"Lemma",formal:"allow"},{id:"Corollary",label:"Corollary",formal:"allow"},{id:"Conjecture",label:"Conjecture",formal:"allow"},{id:"Proof",label:"Proof",formal:"allow"},{id:"HistoricalNote",label:"Historical Note"},{id:"PhilosophicalJustification",label:"Philosophical Justification"},{id:"Diagram",label:"Diagram"},{id:"Example",label:"Example"},{id:"PartialTheorem",label:"Partial Theorem",formal:"allow"}],e.goToStep=function(t){var o=_.indexOf(e.stepsKeys,t);o<=e.activeStep?e.activeStep=o:e.notify("Please complete the current step first before proceeding further.","info",e.$parent)},e.toggleFormalVersion=function(){e.formalVersion=e.formalVersion?!1:!0,e.formalVersion?e.notify("Your contribution is now of type Formal.","info",e.$parent):e.notify("Your contribution is no longer of type Formal.","info",e.$parent)},e.createUmi=function(){var t=e.createUmiForm;if(e.editUmiData)var o={auth:{accessToken:e.omUser.accessToken,gPlusId:e.omUser.id},umiId:e.editUmiData.id,message:"Update UMI",newLatex:t.latexContent};else var r={auth:{accessToken:e.omUser.accessToken,gPlusId:e.omUser.id},message:"Initialise UMI",umiType:t.type.id,title:_.capitalise(t.title),titleSynonyms:t.titleSynonyms?_.cleanseCSV(t.titleSynonyms):[],content:t.latexContent,prerequisiteDefinitionIds:e.autocompleteData.prerequisiteDefinitions?_.keys(e.autocompleteData.prerequisiteDefinitions):[],seeAlsoIds:e.autocompleteData.seeAlso?_.keys(e.autocompleteData.seeAlso):[],tags:t.tags?_.cleanseCSV(t.tags):[]};var i=e.editUmiData?o:r,a=e.editUmiData?["PUT","update-latex"]:["POST","add"];e.contributeData=i,e.http(a[0],a[1],JSON.stringify(i),function(){var t="POST"==a[0]?"Your contribution was successfully posted!":"Your contribution was successfully updated!";e.notify(t,"success",e.$parent,!0)},!1,{"Content-type":"application/json;charset=UTF-8"})},e.latexToHtml=function(){return e.createUmiForm.latexContent?(window.clearTimeout(parseLatexContent),e.parsedLatexContent=e.createUmiForm.latexContent,void(parseLatexContent=_.delay(function(){e.parsingContent=!0,e.timeScale=_.timeScale(e.createUmiForm.latexContent),e.http("POST","latex-to-html",e.createUmiForm.latexContent,function(t){var o,t=JSON.parse(t),i="parsed"==_.first(_.keys(t))?!0:!1;if(i)e.editorError=!1,o=t.parsed;else{var a=_.first(_.values(t)),n=_.parseInt(a[1])-4,s=e.createUmiForm.latexContent.substr(n,8);e.editorError={message:a[0],offset:a[1],where:s},o=e.createUmiForm.latexContent}e.$apply(function(){e.parsedLatexContent=o}),r(function(){e.parsingContent=!1},parseLatexContentProgressTimeout)},!1,{"Content-type":"application/json;charset=UTF-8"})},parseLatexContentTimeout))):(e.parsedLatexContent="",!1)}}]),app.controller("DiveController",["$scope","$http","$location",function(e,t,o){e.$parent.title="Dive Into",e.$parent.transparentNav=!0,e.getUmi=function(t){return t||e.searchUmiResults?void o.path("/board/"+t):!1}}]),app.controller("FeaturesController",["$scope",function(e){e.$parent.title="Features",e.$parent.transparentNav=!0}]);var notificationDisappearTimeout=2500;app.controller("GlobalController",["$scope","$location","$window","$http","$timeout",function(e,t,o,r,i){function a(){var r=t.url().split("/");e.path=""==r[1]?"dive":r[1],o.ga("send","pageview",{page:t.path()})}if(console.log("OpenMaths is now running"),e.$watch(function(){return t.path()},a),e.setTheme=function(t){e.themeClass=t,localStorage.setItem("themeClass",t)},e.themeClass=localStorage.getItem("themeClass")?localStorage.getItem("themeClass"):"light",e.setUmiFont=function(t){e.umiFontClass=t,localStorage.setItem("umiFontClass",t)},e.umiFontClass=localStorage.getItem("umiFontClass")?localStorage.getItem("umiFontClass"):"umi-font-modern",sessionStorage.getItem("omUser")){var n=sessionStorage.getItem("omUser");e.omUser=JSON.parse(n)}e.googleSignIn=function(){return e.omUser?!1:void gapi.auth.signIn({callback:function(t){if(t.status.signed_in){var o=gapi.auth.getToken();r.get("https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token="+o.access_token).success(function(o){o.accessToken=t.access_token,o.avatarStyle={"background-image":"url('"+o.picture+"')"},e.http("POST","arft",o.id,function(r){var i={code:t.code,gPlusId:o.id,arfToken:r};e.http("POST","login",JSON.stringify(i),function(t){var r=JSON.parse(t);"successMsg"==_.first(_.keys(r))?(e.omUser=o,sessionStorage.setItem("omUser",JSON.stringify(o)),e.notify("You are now signed in as "+o.email+".","success",e,!0)):e.notify("There was an error signing you in to our application server.","error",e,!0)},!1,{"Content-type":"application/json;charset=UTF-8"})},!1,{"Content-type":"application/json;charset=UTF-8"})}).error(function(){e.notify("There was an error retrieving user data from Google.","error",e,!0)})}else"immediate_failed"!==t.error&&e.notify("There was an error ("+t.error+") during the sign in process.","error",e,!0)}})},e.googleSignOut=function(){gapi.auth.signOut();var t={accessToken:e.omUser.accessToken,gPlusId:e.omUser.id};e.http("POST","logout",JSON.stringify(t),function(){e.omUser=!1,sessionStorage.removeItem("omUser"),e.notify("You have been successfully signed out.","info",e,!0)},!1,{"Content-type":"application/json;charset=UTF-8"})},e.accessUrlUser=function(o,r,i){return e.omUser?void t.url("/"+o):(e.notify(r,i,e),!1)},e.http=function(t,o,r,i,a,n){var s=new XMLHttpRequest,l=appConfig.apiUrl+"/"+o;return-1==_.indexOf(appConfig.apiCORSMethods,t)?(console.log("Method "+t+" not allowed."),!1):(s.open(t,l,!0),_.forEach(_.keys(n),function(e){s.setRequestHeader(e,n[e])}),s.onreadystatechange=function(){var t=s.responseText;4==s.readyState&&(200==s.status?i(t):a?a(t):e.notify("There was an error with our application server while dealing with your request.","error",e,!0))},void s.send(r))},e.notify=function(e,t,o,r){var a={message:e,type:t,act:!0};r?o.$apply(function(){o.notification=a}):o.notification=a,i(function(){o.notification.act=!1},notificationDisappearTimeout)}}]),app.controller("OoopsController",["$scope","$rootScope",function(e,t){t.title="Ooops"}]),app.controller("SassController",["$scope","$rootScope","$location",function(e,t){t.title="SASS Library"}]);var keyDown=40,keyUp=38,keyReturn=13,simulateDivingMaxTermLength=40;app.controller("SearchController",["$scope","$http",function(e,t){e.searchResultsNavigate=function(t,o,r){if(!t)return!1;var i=_.keys(t.data).length,a=t.currentSelection;if(o.keyCode==keyReturn)if(o.preventDefault(),"getUmi"==_.first(r)){var n=e.searchResults.data[e.searchResults.currentSelection].uriFriendlyTitle;e.$parent[r](n)}else"autocomplete"==_.first(r)&&e.autocomplete(r[1]);return o.keyCode==keyUp&&a>0?(o.preventDefault(),t.currentSelection=a-1):o.keyCode==keyDown&&i-1>a&&(o.preventDefault(),t.currentSelection=a+1),!1},e.search=function(r,i,a){i&&(e.showAutocomplete=!0);var n=function(t,o){var r=t.split("."),i=_.first(r);return r.length>1?(r.reverse().pop(),n(r.reverse().join("."),e[i])):o?o[i]:e[i]},n=n(r,!1),s=n.length;s>0?(a&&o(s),t.get(appConfig.apiUrl+"/search/"+n).success(function(t){if(t.length>0){var o={currentSelection:0,data:t};e.searchResults=o}else e.searchResults=!1,e.notify("No results found :-(","info",e.$parent.$parent)}).error(function(){e.notify("There was an error with the connection to our API.","error",e.$parent.$parent)})):e.searchResults=!1},e.autocomplete=function(t,o){var r=e.searchResults,i=o?r.data[o]:r.data[r.currentSelection];if(e.createUmiForm[t]="",e.showAutocomplete=!1,e.searchResults=!1,e.autocompleteData[t])e.autocompleteData[t][i.id]=i.title;else{var a={};a[i.id]=i.title,e.autocompleteData[t]=a}},e.removeUmiId=function(t,o){delete e.autocompleteData[t][o]};var o=function(e){if(simulateDivingMaxTermLength>e){var t=e*(100/simulateDivingMaxTermLength)+"%";document.getElementById("masthead").style.backgroundPositionY=t}}}]);