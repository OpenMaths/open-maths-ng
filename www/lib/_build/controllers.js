var gridDefaultRowCount=3,gridDefaultColumnCount=3,gridMaxRows=6,gridMinRows=2,gridMaxColumns=6,gridMinColumns=2;app.controller("BoardController",["$scope","$http","$timeout","$routeParams",function(e,t,o,n){e.$parent.title="Board",e.$parent.transparentNav=!1,e.rows=sessionStorage.getItem("gridRows")?parseInt(sessionStorage.getItem("gridRows")):gridDefaultRowCount,e.columns=sessionStorage.getItem("gridColumns")?parseInt(sessionStorage.getItem("gridColumns")):gridDefaultColumnCount;var a=n.id;for(e.grid=[],i=0;i<e.rows;i++){var r=[];for(c=0;c<e.columns;c++)r.push(c);e.grid.push(r)}e.manageGrid=function(t,o){if("row"==o){var n=[];for(i=0;i<e.columns;i++)n.push(i);switch(t){case"add":if(e.rows>gridMaxRows-1)return!1;e.rows=e.rows+1,e.grid.push(n);break;case"remove":if(e.rows<gridMinRows+1)return!1;e.rows=e.rows-1,e.grid.pop()}sessionStorage.setItem("gridRows",e.rows)}else if("column"==o){switch(t){case"add":if(e.columns>gridMaxColumns-1)return!1;for(i=0;i<e.rows;i++)e.grid[i].push(e.columns);e.columns=e.columns+1;break;case"remove":if(e.columns<gridMinColumns+1)return!1;for(i=0;i<e.rows;i++)e.grid[i].pop();e.columns=e.columns-1}sessionStorage.setItem("gridColumns",e.columns)}};var s=function(i,n,a,r){var s=function(){e.fadeInUmi=!0},l="uriFriendlyTitle"==i?appConfig.apiUrl+"/"+n:appConfig.apiUrl+"/"+i+"/"+n;t.get(l).success(function(t){r&&(t.targetClasses=r),e.grid[a[0]][a[1]]=t,o(s,250)}).error(function(){e.$parent.notification={message:"There was an error loading the requested contribution.",type:"error",act:!0},o(function(){e.$parent.notification.act=!1},2500)})};s("uriFriendlyTitle",a,[1,1]),e.position=function(t,o,i,n){var a=[];if("up"==i)var r=[t-1,o];else if("down"==i)var r=[t+1,o];else if("left"==i)var r=[t,o-1];else if("right"==i)var r=[t,o+1];0==r[0]?a.push("closes-top"):r[0]==e.rows-1?a.push("closes-bottom"):0==r[1]?a.push("closes-left"):r[1]==e.columns-1&&a.push("closes-right"),s("id",n,[r[0],r[1]],a.join(" "))}}]);var parseLatexContent,parseLatexContentTimeout=2e3;app.controller("ContributeController",["$scope","$http","$location","$timeout","$routeParams",function(e,t,o,i,n){if(e.omUser||(alert("You must be logged in to Contribute to OpenMaths!"),o.path("/")),e.$parent.title="Contribute",e.$parent.transparentNav=!1,e.autocompleteData={},n.edit){var a=n.edit.split(":");"edit"!==a[0]&&o.path("/contribute"),t.get(appConfig.apiUrl+"/"+a[1]).success(function(t){e.$parent.title=e.editUmiData.title.title,e.editUmiData=t,e.createUmiForm={type:{id:t.umiType,label:t.umiType},title:t.title.title,titleSynonyms:t.titleSynonyms,latexContent:t.latexContent,seeAlso:t.seeAlso,tags:t.tags},e.parsedLatexContent=t.htmlContent}).error(function(){e.$parent.notification={message:"There was an error loading the requested contribution.",type:"error",act:!0},i(function(){e.$parent.notification.act=!1},2500)})}e.goToStep=function(t){var o=_.indexOf(e.stepsKeys,t);o<=e.activeStep?e.activeStep=o:(e.$parent.notification={message:"Please complete the current step first before proceeding further.",type:"info",act:!0},i(function(){e.$parent.notification.act=!1},2500))},e.steps={"basic-settings":"Basic Settings",editor:"Editor","preview-and-publish":"Preview & Publish"},e.stepsKeys=_.keys(e.steps),e.activeStep=0,e.errorMessages={required:"This field is required.",maxLength:"This field is exceeding the maximum length of 128 characters.",umiTitle:"The title should only consist of letters, spaces, or hyphens"},e.instructions={type:"What category of information?",title:"Users will be able to search your contribution.",titleSynonyms:"Comma-separated list of alternative names.",latexContent:"The actual content. You are free to use LaTeX (including text-mode macros!!).",prerequisiteDefinitions:"Comma-separated list of valid dependency Titles.",seeAlso:"Comma-separated list of valid Titles which may be related.",tags:"Comma-separated list of tags to help users find your contribution.",dispatch:"Submitting your contribution will create a request to pull the content into our database."},e.umiTypes=[{id:"Definition",label:"Definition",formal:"allow"},{id:"Axiom",label:"Axiom",formal:"allow"},{id:"Theorem",label:"Theorem",formal:"allow"},{id:"Lemma",label:"Lemma",formal:"allow"},{id:"Corollary",label:"Corollary",formal:"allow"},{id:"Conjecture",label:"Conjecture",formal:"allow"},{id:"Proof",label:"Proof",formal:"allow"},{id:"HistoricalNote",label:"Historical Note"},{id:"PhilosophicalJustification",label:"Philosophical Justification"},{id:"Diagram",label:"Diagram"},{id:"Example",label:"Example"},{id:"PartialTheorem",label:"Partial Theorem",formal:"allow"}],e.toggleFormalVersion=function(){e.formalVersion=e.formalVersion?!1:!0,e.formalVersion?(e.$parent.notification={message:"Your contribution is now of type Formal.",type:"info",act:!0},i(function(){e.$parent.notification.act=!1},2500)):(e.$parent.notification={message:"Your contribution is no longer of type Formal.",type:"warning",act:!0},i(function(){e.$parent.notification.act=!1},2500))},e.createUmi=function(){var t=e.createUmiForm;if(e.editUmiData)var o={umiId:e.editUmiData.id,author:e.omUser.email,message:"Update UMI",newLatex:t.latexContent};else var n={author:e.omUser.email,message:"Initialise UMI",umiType:t.type.id,title:t.title,titleSynonyms:t.titleSynonyms?r(t.titleSynonyms):[],content:t.latexContent,prerequisiteDefinitionIds:e.autocompleteData.prerequisiteDefinitions?_.keys(e.autocompleteData.prerequisiteDefinitions):[],seeAlsoIds:e.autocompleteData.seeAlso?_.keys(e.autocompleteData.seeAlso):[],tags:t.tags?r(t.tags):[]};var a=e.editUmiData?o:n,s=e.editUmiData?["PUT","update-latex"]:["POST","add"];e.contributeData=a,e.http(s[0],s[1],JSON.stringify(a),function(){e.$apply(function(){e.$parent.notification={message:"Your contribution was successfully posted!",type:"success",act:!0},i(function(){e.$parent.notification.act=!1},2500)})},!1,{"Content-type":"application/json;charset=UTF-8"})},e.latexToHtml=function(){return e.createUmiForm.latexContent?(window.clearTimeout(parseLatexContent),e.parsedLatexContent=e.createUmiForm.latexContent,void(parseLatexContent=_.delay(function(){e.parsingContent=!0,e.http("POST","latex-to-html",e.createUmiForm.latexContent,function(t){var o,t=JSON.parse(t),i="parsed"==_.first(_.keys(t))?!0:!1;if(i)e.editorError=!1,o=t.parsed;else{var n=_.first(_.values(t)),a=_.parseInt(n[1])-4,r=e.createUmiForm.latexContent.substr(a,8);e.editorError={message:n[0],offset:n[1],where:r},o=e.createUmiForm.latexContent}e.$apply(function(){e.parsedLatexContent=o}),_.delay(function(){e.$apply(function(){e.parsingContent=!1})},1e3)},!1,{"Content-type":"application/json;charset=UTF-8"})},parseLatexContentTimeout))):(e.parsedLatexContent="",!1)};var r=function(e){var t=e.split(",");return _.map(t,function(e){return e.trim()})}}]),app.controller("DiveController",["$scope","$http","$location",function(e,t,o){e.$parent.title="Dive Into",e.$parent.transparentNav=!0,e.getUmi=function(t){return t||e.searchUmiResults?void o.path("/board/"+t):!1}}]),app.controller("FeaturesController",["$scope",function(e){e.$parent.title="Features",e.$parent.transparentNav=!0}]),app.controller("GlobalController",["$scope","$location","$window","$http","$timeout",function(e,t,o,i,n){function a(){var i=t.url().split("/");e.path=""==i[1]?"dive":i[1],o.ga("send","pageview",{page:t.path()})}if(console.log("OpenMaths is now running"),e.$watch(function(){return t.path()},a),e.setTheme=function(t){e.themeClass=t,localStorage.setItem("themeClass",t)},e.themeClass=localStorage.getItem("themeClass")?localStorage.getItem("themeClass"):"light",e.setUmiFont=function(t){e.umiFontClass=t,localStorage.setItem("umiFontClass",t)},e.umiFontClass=localStorage.getItem("umiFontClass")?localStorage.getItem("umiFontClass"):"umi-font-modern",sessionStorage.getItem("omUser")){var r=sessionStorage.getItem("omUser");e.omUser=JSON.parse(r)}e.googleSignIn=function(){return e.omUser?!1:void gapi.auth.signIn({callback:function(t){if(t.status.signed_in){var o=gapi.auth.getToken();console.log(t),i.get("https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token="+o.access_token).success(function(o){e.omUser=o,sessionStorage.setItem("omUser",JSON.stringify(o)),e.notification={message:"You are now signed in as "+o.email+".",type:"success",act:!0},n(function(){e.notification.act=!1},2500);var i={token:t.access_token,clientId:o.id};e.http("POST","auth",JSON.stringify(i),function(e){alert(e)},!1,{"Content-type":"application/json;charset=UTF-8"})}).error(function(){e.notification={message:"There was an error during the sign in process.",type:"error",act:!0},n(function(){e.notification.act=!1},2500)})}else e.notification={message:"There was an error ("+t.error+") during the sign in process.",type:"error",act:!0},n(function(){e.notification.act=!1},2500)}})},e.googleSignOut=function(){gapi.auth.signOut(),e.omUser=!1,sessionStorage.removeItem("omUser"),e.notification={message:"You have been successfully signed out.",type:"info",act:!0},n(function(){e.notification.act=!1},2500)},e.accessUrlUser=function(o,i,a){return e.omUser?void t.url("/"+o):(e.notification={message:i,type:a,act:!0},n(function(){e.notification.act=!1},2500),!1)},e.http=function(t,o,i,a,r,s){var l=new XMLHttpRequest,c=appConfig.apiUrl+"/"+o;l.open(t,c,!0),_.forEach(_.keys(s),function(e){l.setRequestHeader(e,s[e])}),l.onreadystatechange=function(){var t=l.responseText;4==l.readyState&&(200==l.status?a(t):r?r(t):e.$apply(function(){e.notification={message:"There was an error with our application server while dealing with your request.",type:"error",act:!0},n(function(){e.notification.act=!1},2500)}))},l.send(i)}}]),app.controller("OoopsController",["$scope","$rootScope",function(e,t){t.title="Ooops"}]),app.controller("SassController",["$scope","$rootScope","$location",function(e,t){t.title="SASS Library"}]),app.controller("SearchController",["$scope","$http","$timeout",function(e,t,o){e.searchResultsNavigate=function(t,o,i){if(!t)return!1;var n=_.keys(t.data).length,a=t.currentSelection;if(13==o.keyCode)if(o.preventDefault(),"getUmi"==_.first(i)){var r=e.searchResults.data[e.searchResults.currentSelection].uriFriendlyTitle;e.$parent[i](r)}else"autocomplete"==_.first(i)&&e.autocomplete(i[1]);return 38==o.keyCode&&a>0?(o.preventDefault(),t.currentSelection=a-1):40==o.keyCode&&n-1>a&&(o.preventDefault(),t.currentSelection=a+1),!1},e.search=function(n,a,r){a&&(e.showAutocomplete=!0);var s=function(t,o){var i=t.split("."),n=_.first(i);return i.length>1?(i.reverse().pop(),s(i.reverse().join("."),e[n])):o?o[n]:e[n]},s=s(n,!1),l=s.length;l>0?(r&&i(l),t.get(appConfig.apiUrl+"/search/"+s).success(function(t){if(t.length>0){var o={currentSelection:0,data:t};e.searchResults=o}else e.searchResults=!1}).error(function(){e.$parent.$parent.notification={message:"There was an error with the connection to our API.",type:"error",act:!0},o(function(){e.$parent.$parent.notification.act=!1},2500)})):e.searchResults=!1},e.autocomplete=function(t,o){var i=e.searchResults,n=o?i.data[o]:i.data[i.currentSelection];if(e.createUmiForm[t]="",e.showAutocomplete=!1,e.searchResults=!1,e.autocompleteData[t])e.autocompleteData[t][n.id]=n.title;else{var a={};a[n.id]=n.title,e.autocompleteData[t]=a}},e.removeUmiId=function(t,o){delete e.autocompleteData[t][o]};var i=function(e){if(40>e){var t=2.5*e+"%";document.getElementById("masthead").style.backgroundPositionY=t}}}]);