!function(){"use strict";function e(e,t,o){function r(r,n,i){e.get("https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token="+n.access_token).success(function(n){n.accessToken=r.access_token,n.avatarStyle={"background-image":"url('"+n.picture+"')"},e.post(o.api+"arft",n.id).success(function(a){var s={code:r.code,gPlusId:n.id,arfToken:a};e.post(o.api+"login",s).success(function(e){"successMsg"==_.first(_.keys(e))?i(n):t.generate("There was an error signing you in to our application server.","error",e)}).error(function(e){t.generate("There was an error signing you in to our application server.","error",e)})}).error(function(e){t.generate("There was an error getting the anti request forgery token from our application server.","error",e)})}).error(function(e){t.generate("There was an error retrieving user data from Google.","error",e)})}function n(r,n){e.post(o.api+"logout",r).success(function(){n()}).error(function(e,o){t.generate("There was an error signing you out of our application server.","error",[e,o])})}return{signIn:r,signOut:n}}angular.module("omApp").factory("omAuth",e),e.$inject=["$http","notification","magic"]}(),function(){"use strict";function e(e,t,o,r){function n(n){e.initGapi=function(){n.gapiActive=!0},n.googleSignIn=function(){return n.omUser?(n.dropDownUser=n.dropDownUser?!1:!0,!1):void gapi.auth.signIn({callback:function(e){1==e.status.signed_in?o.signIn(e,gapi.auth.getToken(),i):"immediate_failed"!==e.error&&t.generate("There was an error ("+e.error+") during the sign in process.","error")}})},n.googleSignOut=function(){gapi.auth.signOut(),o.signOut({accessToken:n.omUser.accessToken,gPlusId:n.omUser.id},a)};var i=function(e){sessionStorage.setItem("omUser",JSON.stringify(e)),n.omUser=e,t.generate("You are now signed in as "+e.email+".","success")},a=function(){sessionStorage.removeItem("omUser"),n.omUser=!1,t.generate("You have been successfully signed out.","info")};n.setUI=function(e,t){var o=n.uiSettings;switch(e){case"font":o.font=t;break;case"theme":o.theme=t}r.set("uiSettings",o),n.uiSettings=o}}var i={restrict:"EA",templateUrl:"app/sections/navigation/layout.html",link:n};return i}angular.module("omApp").directive("navTopLayout",e),e.$inject=["$window","notification","omAuth","lStorage"]}(),function(){"use strict";function e(e,t,o){function r(r,n){return-1==_.indexOf(o.allowedTypes,n)?(e.debug("Method "+n+" not allowed."),!1):void(t.debug?e[n](r):"")}var n={log:r};return n}angular.module("omApp").factory("logger",e).constant("magicForLoggerFactory",{allowedTypes:["info","warn","error","debug","log"]}),e.$inject=["$log","magic","magicForLoggerFactory"]}(),function(){"use strict";function e(e,t,o){var r=40,n=38,i=13,a=40;e.searchResultsNavigate=function(t,o,a){if(!t)return!1;var s=_.keys(t.data).length,l=t.currentSelection;if(o.keyCode==i)if(o.preventDefault(),"getUmi"==_.first(a)){var c=e.searchResults.data[e.searchResults.currentSelection].uriFriendlyTitle;e[a](c)}else"autocomplete"==_.first(a)&&e.autocomplete(a[1]);return o.keyCode==n&&l>0?(o.preventDefault(),t.currentSelection=l-1):o.keyCode==r&&s-1>l&&(o.preventDefault(),t.currentSelection=l+1),!1},e.search=function(r,n,i){n&&(e.showAutocomplete=!0);var a=function(t,o){var r=t.split("."),n=_.first(r);return r.length>1?(r.reverse().pop(),a(r.reverse().join("."),e[n])):o?o[n]:e[n]},a=a(r,!1),l=a.length;l>0?(i&&s(l),t.get(appConfig.apiUrl+"search/"+a).success(function(t){if(t.length>0){var r={currentSelection:0,data:t};e.searchResults=r}else e.searchResults=!1,o.generate("No results found :-(","info")}).error(function(e){o.generate("There was an error with the connection to our API.","error",e)})):e.searchResults=!1},e.autocomplete=function(t,o){var r=e.searchResults,n=o?r.data[o]:r.data[r.currentSelection];if(e.createUmiForm[t]="",e.showAutocomplete=!1,e.searchResults=!1,e.autocompleteData[t])e.autocompleteData[t][n.id]=n.title;else{var i={};i[n.id]=n.title,e.autocompleteData[t]=i}},e.removeUmiId=function(t,o){delete e.autocompleteData[t][o]};var s=function(e){if(a>e){var t=e*(100/a)+"%";document.getElementById("masthead").style.backgroundPositionY=t}}}angular.module("omApp").controller("SearchController",e),e.$inject=["$scope","$http","notification"]}(),function(){"use strict";function e(e,t){function o(o){var r=2500;t.subscribe(function(t){o.notification=t,o.act=!0,e(function(){o.act=!1},r)})}var r={restrict:"EA",templateUrl:"app/sections/notification/layout.html",scope:{},replace:!0,link:o};return r}angular.module("omApp").directive("notificationLayout",e),e.$inject=["$timeout","notification"]}(),function(){"use strict";function e(e,t){function o(e){n.push(e)}function r(o,r,i){if(-1==_.indexOf(t.allowedTypes,r))return e.log("Method "+r+" not allowed.","debug"),!1;var a={message:o,type:r};i&&(a.trace=i),e.log(a,"info"),_.forEach(n,function(e){e(a)})}var n=[];return{subscribe:o,generate:r}}angular.module("omApp").factory("notification",e).constant("magicForNotificationFactory",{allowedTypes:["info","warning","error","success"]}),e.$inject=["logger","magicForNotificationFactory"]}(),function(){"use strict";function e(e,t){e.$parent.title=t.pageTitle,e.$parent.transparentNav=t.pageTransparentNav}angular.module("omApp").controller("BoardController",e).constant("magicForBoard",{pageTitle:"Board",pageTransparentNav:!1}),e.$inject=["$scope","magicForBoard"]}(),function(){"use strict";function e(e,t,o,r,n,i,a,s){function l(l){l.rows=n.get("gridRows")?_.parseInt(n.get("gridRows")):s.gridDefaultRowCount,l.columns=n.get("gridColumns")?_.parseInt(n.get("gridColumns")):s.gridDefaultColumnCount;for(var c=e.uriFriendlyTitle,u=[],g=0;g<l.rows;g++){for(var m=[],p=0;p<l.columns;p++)m.push(p);u.push(m)}l.grid=u,l.manageGrid=function(e,t){if("row"==t){for(var o=[],r=0;r<l.columns;r++)o.push(r);switch(e){case"add":if(l.rows>s.gridMaxRows-1)return!1;l.rows=l.rows+1,l.grid.push(o);break;case"remove":if(l.rows<s.gridMinRows+1)return!1;l.rows=l.rows-1,l.grid.pop();break;default:return i.log("Method"+e+"not allowed","debug"),!1}return n.set("gridRows",l.rows),!0}if("column"==t){switch(e){case"add":if(l.columns>s.gridMaxColumns-1)return!1;for(var r=0;r<l.rows;r++)l.grid[r].push(l.columns);l.columns=l.columns+1;break;case"remove":if(l.columns<s.gridMinColumns+1)return!1;for(r=0;r<l.rows;r++)l.grid[r].pop();l.columns=l.columns-1;break;default:return i.log("Method"+e+"not allowed","debug"),!1}return n.set("gridColumns",l.columns),!0}return i.log("Type"+t+"not allowed","debug"),!1};var f=function(e,n,i,c){var u=function(){l.fadeInUmi=!0},g="uriFriendlyTitle"==e?a.api+n:a.api+e+"/"+n;t.get(g).success(function(e){c&&(e.targetClasses=c),l.grid[i.row][i.column]=e,o(u,s.fadeUmiTimeout)}).error(function(e){r.generate("There was an error loading requested contribution.","error",e)})};f("uriFriendlyTitle",c,s.gridStartingPosition,!1),l.position=function(e,t,o,r){var n=[];if("up"==o)var i=[e-1,t];else if("down"==o)var i=[e+1,t];else if("left"==o)var i=[e,t-1];else if("right"==o)var i=[e,t+1];0==i[0]?n.push("closes-top"):i[0]==l.rows-1?n.push("closes-bottom"):0==i[1]?n.push("closes-left"):i[1]==l.columns-1&&n.push("closes-right");var i={row:i[0],column:i[1]};f("id",r,i,n.join(" "))}}var c={restrict:"EA",templateUrl:"app/sections/section.board/board.layout.html",link:l};return c}angular.module("omApp").directive("boardLayout",e).constant("magicForBoardDirective",{fadeUmiTimeout:250,gridDefaultRowCount:3,gridDefaultColumnCount:3,gridMaxRows:6,gridMinRows:2,gridMaxColumns:6,gridMinColumns:2,gridStartingPosition:{row:1,column:1}}),e.$inject=["$routeParams","$http","$timeout","notification","sStorage","logger","magic","magicForBoardDirective"]}(),function(){"use strict";function e(e,t,o,r,n){var i;e.$parent.title=magicForContribute.pageTitle,e.$parent.transparentNav=magicForContribute.pageTransparentNav,e.omUser||(alert("You must be logged in to Contribute to OpenMaths!"),t.path("/")),e.autocompleteData={},e.steps={"basic-settings":"Basic Settings",editor:"Editor","preview-and-publish":"Preview & Publish"},e.stepsKeys=_.keys(e.steps),e.activeStep=0,e.errorMessages={required:"This field is required.",maxLength:"This field is exceeding the maximum length of 128 characters.",umiTitle:"The title should only consist of letters, spaces, or hyphens"},e.instructions={type:"What category of information?",title:"Users will be able to search your contribution.",titleSynonyms:"Comma-separated list of alternative names.",latexContent:"The actual content. You are free to use LaTeX (including text-mode macros!!).",prerequisiteDefinitions:"Comma-separated list of valid dependency Titles.",seeAlso:"Comma-separated list of valid Titles which may be related.",tags:"Comma-separated list of tags to help users find your contribution.",dispatch:"Submitting your contribution will create a request to pull the content into our database."},e.umiTypes=[{id:"Definition",label:"Definition",formal:"allow"},{id:"Axiom",label:"Axiom",formal:"allow"},{id:"Theorem",label:"Theorem",formal:"allow"},{id:"Lemma",label:"Lemma",formal:"allow"},{id:"Corollary",label:"Corollary",formal:"allow"},{id:"Conjecture",label:"Conjecture",formal:"allow"},{id:"Proof",label:"Proof",formal:"allow"},{id:"HistoricalNote",label:"Historical Note"},{id:"PhilosophicalJustification",label:"Philosophical Justification"},{id:"Diagram",label:"Diagram"},{id:"Example",label:"Example"},{id:"PartialTheorem",label:"Partial Theorem",formal:"allow"}],e.goToStep=function(t){var o=_.indexOf(e.stepsKeys,t);o<=e.activeStep?e.activeStep=o:n.generate("Please complete the current step first before proceeding further.","info",e.$parent)},e.toggleFormalVersion=function(){e.formalVersion=e.formalVersion?!1:!0,e.formalVersion?n.generate("Your contribution is now of type Formal.","info",e.$parent):n.generate("Your contribution is no longer of type Formal.","info",e.$parent)},e.createUmi=function(){var t=e.createUmiForm,o={auth:{accessToken:e.omUser.accessToken,gPlusId:e.omUser.id},message:"Initialise UMI",umiType:t.type.id,title:_.capitalise(t.title),titleSynonyms:t.titleSynonyms?_.cleanseCSV(t.titleSynonyms):[],content:t.latexContent,prerequisiteDefinitionIds:e.autocompleteData.prerequisiteDefinitions?_.keys(e.autocompleteData.prerequisiteDefinitions):[],seeAlsoIds:e.autocompleteData.seeAlso?_.keys(e.autocompleteData.seeAlso):[],tags:t.tags?_.cleanseCSV(t.tags):[]};e.contributeData=o,CORS.request("POST","add",JSON.stringify(o),function(){n.generate("Your contribution was successfully posted!","success",e.$parent,!0)},!1,{"Content-type":"application/json;charset=UTF-8"})},e.latexToHtml=function(){return e.createUmiForm.latexContent?(window.clearTimeout(i),e.parsedLatexContent=e.createUmiForm.latexContent,void(i=_.delay(function(){e.parsingContent=!0,e.timeScale=_.timeScale(e.createUmiForm.latexContent),CORS.request("POST","latex-to-html",e.createUmiForm.latexContent,function(t){var r,t=JSON.parse(t),n="parsed"==_.first(_.keys(t))?!0:!1;if(n)e.editorError=!1,r=t.parsed;else{var i=_.first(_.values(t)),a=_.parseInt(i[1])-4,s=e.createUmiForm.latexContent.substr(a,8);e.editorError={message:i[0],offset:i[1],where:s},r=e.createUmiForm.latexContent}e.$apply(function(){e.parsedLatexContent=r}),o(function(){e.parsingContent=!1},magicForContribute.parseLatexContentProgressTimeout)},!1,{"Content-type":"application/json;charset=UTF-8"})},magicForContribute.parseLatexContentTimeout))):(e.parsedLatexContent="",!1)}}angular.module("omApp").controller("ContributeController",e).constant("magicForContribute",{pageTitle:"Contribute",pageTransparentNav:!1,parseLatexContentTimeout:2e3,parseLatexContentProgressTimeout:800}),e.$inject=["$scope","$location","$timeout","magic","notification"]}(),function(){"use strict";function e(e,t){e.$parent.title=t.pageTitle,e.$parent.transparentNav=t.pageTransparentNav}angular.module("omApp").controller("DiveController",e).constant("magicForDive",{pageTitle:"Dive Into",pageTransparentNav:!0}),e.$inject=["$scope","magicForDive"]}(),function(){"use strict";function e(e,t){function o(o){o.getUmi=function(o){return o?void e.path("/board/"+o):(t.generate("No URI argument present","error"),!1)}}var r={restrict:"EA",templateUrl:"app/sections/section.dive/dive.layout.html",link:o,controller:"SearchController"};return r}angular.module("omApp").directive("diveLayout",e),e.$inject=["$location","notification"]}(),function(){"use strict";function e(e,t,o,r,n,i,a,s){e.title=s.pageTitle,e.siteName=a.siteName,e.siteLanguage=a.siteLanguage,e.description=a.description,e.$watch(function(){return t.path()},function(){var r=t.url().split("/");e.path=""==r[1]?s.pageDefaultWelcomeLabel:r[1],i.log("Current location: "+t.path(),"info"),o.ga("send","pageview",{page:t.path()})}),e.uiSettings=r.get("uiSettings")?r.get("uiSettings"):s.uiSettings,e.omUser=n.get("omUser")?n.get("omUser"):!1}angular.module("omApp").controller("GlobalController",e).constant("magicForGlobal",{pageTitle:"Page",pageDefaultWelcomeLabel:"dive",uiSettingsDefault:{theme:"light",font:"umi-font-modern"}}).constant("magic",{siteName:"OpenMaths",siteLanguage:"en",description:"The way Mathematics should have been done.",api:_.getApiUrl(),debug:_.getDebug()}),e.$inject=["$scope","$location","$window","lStorage","sStorage","logger","magic","magicForGlobal"]}(),function(){"use strict";function e(){var e={restrict:"A",link:function(e,t){t.bind("click",function(e){e.stopPropagation()})}};return e}angular.module("omApp").directive("stopEvent",e)}(),function(){"use strict";function e(e){function t(t,o){return e.localStorage.setItem(t,JSON.stringify(o)),!0}function o(t){var o=e.localStorage.getItem(t);return o?JSON.parse(o):!1}var r={set:t,get:o};return r}angular.module("omApp").factory("lStorage",e),e.$inject=["$window"]}(),function(){"use strict";function e(e){function t(t,o){return e.sessionStorage.setItem(t,JSON.stringify(o)),!0}function o(t){var o=e.sessionStorage.getItem(t);return o?JSON.parse(o):!1}var r={set:t,get:o};return r}angular.module("omApp").factory("sStorage",e),e.$inject=["$window"]}();