!function(){"use strict";function e(e,t,o){function n(n,a,r){e.get("https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token="+a.access_token).success(function(e){e.accessToken=n.access_token,e.avatarStyle={"background-image":"url('"+e.picture+"')"},t.request("POST","arft",e.id,function(a){var i={code:n.code,gPlusId:e.id,arfToken:a};t.request("POST","login",JSON.stringify(i),function(t){var n=JSON.parse(t);"successMsg"==_.first(_.keys(n))?r(e):o.generate("There was an error signing you in to our application server.","error")},!1,{"Content-type":"application/json;charset=UTF-8"})},!1,{"Content-type":"application/json;charset=UTF-8"})}).error(function(){o.generate("There was an error retrieving user data from Google.","error")})}function a(e,o){t.request("POST","logout",JSON.stringify(e),function(){o(!0)},!1,{"Content-type":"application/json;charset=UTF-8"})}return{signIn:n,signOut:a}}angular.module("omApp").factory("omAuth",e),e.$inject=["$http","CORS","notification"]}(),function(){"use strict";function e(e){function t(t,o,n,a,r,i){var s=new XMLHttpRequest,l=appConfig.apiUrl+"/"+o;return-1==_.indexOf(appConfig.apiCORSMethods,t)?(e.generate("Method "+t+" not allowed.","error"),!1):(s.open(t,l,!0),_.forEach(_.keys(i),function(e){s.setRequestHeader(e,i[e])}),s.onreadystatechange=function(){var t=s.responseText;4==s.readyState&&(200==s.status?a(t):r?r(t):e.generate("There was an error with our application server while dealing with your request.","error"))},void s.send(n))}return{request:t}}angular.module("omApp").factory("CORS",e),e.$inject=["notification"]}(),function(){"use strict";function e(e,t,o,n,a,r){var i=n.id,s=[];e.$parent.title=r.pageTitle,e.$parent.transparentNav=r.pageTransparentNav,e.rows=sessionStorage.getItem("gridRows")?_.parseInt(sessionStorage.getItem("gridRows")):r.gridDefaultRowCount,e.columns=sessionStorage.getItem("gridColumns")?_.parseInt(sessionStorage.getItem("gridColumns")):r.gridDefaultColumnCount;for(var l=0;l<e.rows;l++){for(var c=[],u=0;u<e.columns;u++)c.push(u);s.push(c)}e.grid=s,e.manageGrid=function(t,o){if("row"==o){for(var n=[],a=0;a<e.columns;a++)n.push(a);switch(t){case"add":if(e.rows>r.gridMaxRows-1)return!1;e.rows=e.rows+1,e.grid.push(n);break;case"remove":if(e.rows<r.gridMinRows+1)return!1;e.rows=e.rows-1,e.grid.pop()}sessionStorage.setItem("gridRows",e.rows)}else if("column"==o){switch(t){case"add":if(e.columns>r.gridMaxColumns-1)return!1;for(var a=0;a<e.rows;a++)e.grid[a].push(e.columns);e.columns=e.columns+1;break;case"remove":if(e.columns<r.gridMinColumns+1)return!1;for(a=0;a<e.rows;a++)e.grid[a].pop();e.columns=e.columns-1}sessionStorage.setItem("gridColumns",e.columns)}};var p=function(n,i,s,l){var c=function(){e.fadeInUmi=!0},u="uriFriendlyTitle"==n?appConfig.apiUrl+"/"+i:appConfig.apiUrl+"/"+n+"/"+i;t.get(u).success(function(t){l&&(t.targetClasses=l),e.grid[s.row][s.column]=t,o(c,r.fadeUmiTimeout)}).error(function(){a.generate("There was an error loading requested contribution.","error",e.$parent)})};p("uriFriendlyTitle",i,r.gridStartingPosition,!1),e.position=function(t,o,n,a){var r=[];if("up"==n)var i=[t-1,o];else if("down"==n)var i=[t+1,o];else if("left"==n)var i=[t,o-1];else if("right"==n)var i=[t,o+1];0==i[0]?r.push("closes-top"):i[0]==e.rows-1?r.push("closes-bottom"):0==i[1]?r.push("closes-left"):i[1]==e.columns-1&&r.push("closes-right");var i={row:i[0],column:i[1]};p("id",a,i,r.join(" "))}}angular.module("omApp").controller("BoardController",e).constant("magicForBoard",{pageTitle:"Board",pageTransparentNav:!1,gridDefaultRowCount:3,gridDefaultColumnCount:3,gridMaxRows:6,gridMinRows:2,gridMaxColumns:6,gridMinColumns:2,gridStartingPosition:{row:1,column:1},fadeUmiTimeout:250}),e.$inject=["$scope","$http","$timeout","$routeParams","notification","magicForBoard"]}(),function(){"use strict";function e(e,t,o,n,a){var r;e.$parent.title=n.pageTitle,e.$parent.transparentNav=n.pageTransparentNav,e.omUser||(alert("You must be logged in to Contribute to OpenMaths!"),t.path("/")),e.autocompleteData={},e.steps={"basic-settings":"Basic Settings",editor:"Editor","preview-and-publish":"Preview & Publish"},e.stepsKeys=_.keys(e.steps),e.activeStep=0,e.errorMessages={required:"This field is required.",maxLength:"This field is exceeding the maximum length of 128 characters.",umiTitle:"The title should only consist of letters, spaces, or hyphens"},e.instructions={type:"What category of information?",title:"Users will be able to search your contribution.",titleSynonyms:"Comma-separated list of alternative names.",latexContent:"The actual content. You are free to use LaTeX (including text-mode macros!!).",prerequisiteDefinitions:"Comma-separated list of valid dependency Titles.",seeAlso:"Comma-separated list of valid Titles which may be related.",tags:"Comma-separated list of tags to help users find your contribution.",dispatch:"Submitting your contribution will create a request to pull the content into our database."},e.umiTypes=[{id:"Definition",label:"Definition",formal:"allow"},{id:"Axiom",label:"Axiom",formal:"allow"},{id:"Theorem",label:"Theorem",formal:"allow"},{id:"Lemma",label:"Lemma",formal:"allow"},{id:"Corollary",label:"Corollary",formal:"allow"},{id:"Conjecture",label:"Conjecture",formal:"allow"},{id:"Proof",label:"Proof",formal:"allow"},{id:"HistoricalNote",label:"Historical Note"},{id:"PhilosophicalJustification",label:"Philosophical Justification"},{id:"Diagram",label:"Diagram"},{id:"Example",label:"Example"},{id:"PartialTheorem",label:"Partial Theorem",formal:"allow"}],e.goToStep=function(t){var o=_.indexOf(e.stepsKeys,t);o<=e.activeStep?e.activeStep=o:a.generate("Please complete the current step first before proceeding further.","info",e.$parent)},e.toggleFormalVersion=function(){e.formalVersion=e.formalVersion?!1:!0,e.formalVersion?a.generate("Your contribution is now of type Formal.","info",e.$parent):a.generate("Your contribution is no longer of type Formal.","info",e.$parent)},e.createUmi=function(){var t=e.createUmiForm,o={auth:{accessToken:e.omUser.accessToken,gPlusId:e.omUser.id},message:"Initialise UMI",umiType:t.type.id,title:_.capitalise(t.title),titleSynonyms:t.titleSynonyms?_.cleanseCSV(t.titleSynonyms):[],content:t.latexContent,prerequisiteDefinitionIds:e.autocompleteData.prerequisiteDefinitions?_.keys(e.autocompleteData.prerequisiteDefinitions):[],seeAlsoIds:e.autocompleteData.seeAlso?_.keys(e.autocompleteData.seeAlso):[],tags:t.tags?_.cleanseCSV(t.tags):[]};e.contributeData=o,CORS.request("POST","add",JSON.stringify(o),function(){a.generate("Your contribution was successfully posted!","success",e.$parent,!0)},!1,{"Content-type":"application/json;charset=UTF-8"})},e.latexToHtml=function(){return e.createUmiForm.latexContent?(window.clearTimeout(r),e.parsedLatexContent=e.createUmiForm.latexContent,void(r=_.delay(function(){e.parsingContent=!0,e.timeScale=_.timeScale(e.createUmiForm.latexContent),CORS.request("POST","latex-to-html",e.createUmiForm.latexContent,function(t){var a,t=JSON.parse(t),r="parsed"==_.first(_.keys(t))?!0:!1;if(r)e.editorError=!1,a=t.parsed;else{var i=_.first(_.values(t)),s=_.parseInt(i[1])-4,l=e.createUmiForm.latexContent.substr(s,8);e.editorError={message:i[0],offset:i[1],where:l},a=e.createUmiForm.latexContent}e.$apply(function(){e.parsedLatexContent=a}),o(function(){e.parsingContent=!1},n.parseLatexContentProgressTimeout)},!1,{"Content-type":"application/json;charset=UTF-8"})},n.parseLatexContentTimeout))):(e.parsedLatexContent="",!1)}}angular.module("omApp").controller("ContributeController",e).constant("magic",{pageTitle:"Contribute",pageTransparentNav:!1,parseLatexContentTimeout:2e3,parseLatexContentProgressTimeout:800}),e.$inject=["$scope","$location","$timeout","magic","notification"]}(),function(){"use strict";function e(e){function t(t){e.initGapi=function(){t.gapiActive=!0},t.googleSignIn=function(){alert("ok!")}}var o={restrict:"EA",templateUrl:"app/sections/navigation/nav-top.layout.html",link:t};return o}angular.module("omApp").directive("navTop",e),e.$inject=["$window"]}(),function(){"use strict";function e(e,t,o,n){e.$parent.title=n.pageTitle,e.$parent.transparentNav=n.pageTransparentNav,e.getUmi=function(n){return n?void t.path("/board/"+n):(o.generate("No URI argument present","error",e),!1)}}angular.module("omApp").controller("DiveController",e).constant("magicForDive",{pageTitle:"Dive Into",pageTransparentNav:!0}),e.$inject=["$scope","$location","notification","magicForDive"]}(),function(){"use strict";function e(e,t,o,n,a,r){e.title=r.pageTitle,e.siteName=appConfig.siteName,e.siteLanguage=appConfig.siteLanguage,e.description=appConfig.description[appConfig.siteLanguage],e.$watch(function(){return t.path()},function(){var n=t.url().split("/");e.path=""==n[1]?r.pageDefaultWelcomeLabel:n[1],o.ga("send","pageview",{page:t.path()})});if(e.setTheme=function(t){e.themeClass=t,localStorage.setItem("themeClass",t)},e.themeClass=localStorage.getItem("themeClass")?localStorage.getItem("themeClass"):"light",e.setUmiFont=function(t){e.umiFontClass=t,localStorage.setItem("umiFontClass",t)},e.umiFontClass=localStorage.getItem("umiFontClass")?localStorage.getItem("umiFontClass"):"umi-font-modern",sessionStorage.getItem("omUser")){var i=sessionStorage.getItem("omUser");e.omUser=JSON.parse(i)}}angular.module("omApp").controller("GlobalController",e).constant("magicForGlobal",{pageTitle:"Page",pageDefaultWelcomeLabel:"dive"}),e.$inject=["$scope","$location","$window","notification","omAuth","magicForGlobal"]}(),function(){"use strict";function e(e,t){function o(o){var n=2500;t.subscribe(function(t){o.notification=t,o.act=!0,e(function(){o.act=!1},n)})}var n={restrict:"EA",templateUrl:"app/sections/section.global/notification.layout.html",scope:{},replace:!0,link:o};return n}angular.module("omApp").directive("notificationDirective",e),e.$inject=["$timeout","notification"]}(),function(){"use strict";function e(e){function t(e){n.push(e)}function o(t,o){switch(o){case"info":e.info(t);break;case"warning":e.warn(t);break;case"error":e.error(t);break;case"success":e.info(t);break;default:o="info",e.info(t)}var a={message:t,type:o};_.forEach(n,function(e){e(a)})}var n=[];return{subscribe:t,generate:o}}angular.module("omApp").factory("notification",e),e.$inject=["$log"]}(),function(){"use strict";function e(e,t,o){var n=40,a=38,r=13,i=40;e.searchResultsNavigate=function(t,o,i){if(!t)return!1;var s=_.keys(t.data).length,l=t.currentSelection;if(o.keyCode==r)if(o.preventDefault(),"getUmi"==_.first(i)){var c=e.searchResults.data[e.searchResults.currentSelection].uriFriendlyTitle;e.$parent[i](c)}else"autocomplete"==_.first(i)&&e.autocomplete(i[1]);return o.keyCode==a&&l>0?(o.preventDefault(),t.currentSelection=l-1):o.keyCode==n&&s-1>l&&(o.preventDefault(),t.currentSelection=l+1),!1},e.search=function(n,a,r){a&&(e.showAutocomplete=!0);var i=function(t,o){var n=t.split("."),a=_.first(n);return n.length>1?(n.reverse().pop(),i(n.reverse().join("."),e[a])):o?o[a]:e[a]},i=i(n,!1),l=i.length;l>0?(r&&s(l),t.get(appConfig.apiUrl+"/search/"+i).success(function(t){if(t.length>0){var n={currentSelection:0,data:t};e.searchResults=n}else e.searchResults=!1,o.generate("No results found :-(","info")}).error(function(){o.generate("There was an error with the connection to our API.","error")})):e.searchResults=!1},e.autocomplete=function(t,o){var n=e.searchResults,a=o?n.data[o]:n.data[n.currentSelection];if(e.createUmiForm[t]="",e.showAutocomplete=!1,e.searchResults=!1,e.autocompleteData[t])e.autocompleteData[t][a.id]=a.title;else{var r={};r[a.id]=a.title,e.autocompleteData[t]=r}},e.removeUmiId=function(t,o){delete e.autocompleteData[t][o]};var s=function(e){if(i>e){var t=e*(100/i)+"%";document.getElementById("masthead").style.backgroundPositionY=t}}}angular.module("omApp").controller("SearchController",e),e.$inject=["$scope","$http","notification"]}(),function(){"use strict";function e(){var e={restrict:"A",link:function(e,t){t.bind("click",function(e){e.stopPropagation()})}};return e}angular.module("omApp").directive("stopEvent",e)}();